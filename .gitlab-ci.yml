# Define stages
stages:
  - test
  - notify
  - merge

# Define variables
variables:
  NODE_VERSION: "20"
  YARN_VERSION: "1.22.22"
  YARN_CACHE_FOLDER: "$CI_PROJECT_DIR/.yarn-cache"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  SMTP_HOST: "smtp.office365.com"
  SMTP_PORT: "587"
  SMTP_SECURE: "false"

# Cache configuration
cache:
  # The cache key is generated based on the yarn.lock file
  # When yarn.lock changes, a new cache is created
  key:
    files:
      - yarn.lock
  # Cache the node_modules directory to speed up builds
  # This prevents downloading dependencies on every pipeline run
  paths:
    - .yarn-cache/
    - node_modules/
  # pull-push policy:
  # - 'pull': tries to download cache before job execution
  # - 'push': uploads new cache after job completion
  # This ensures cache is both retrieved and updated
  policy: pull-push

# Default image
default:
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Unit tests job
unit_tests:
  stage: test
  tags:
    - rmsdktest
  before_script:
    - |
      echo "=== Environment Variables Debug ==="
      echo "API_BASE_URL: ${API_BASE_URL}"
      echo "API_VERSION: ${API_VERSION}"
      echo "TEST_USERNAME: ${TEST_USERNAME}"
      echo "TEST_PASSWORD: ${TEST_PASSWORD}"
      echo "=== End Environment Variables Debug ==="
    - |
      if ! command -v yarn &> /dev/null; then
        npm install -g yarn@${YARN_VERSION}
      else
        echo "Yarn is already installed"
      fi
    - yarn --version
    # Set a higher network timeout (5 minutes) to prevent timeouts during package installation
    # This is especially important in CI environments where network conditions may be less reliable
    - yarn config set network-timeout 300000
    # Configure Yarn
    - yarn config set cache-folder ${YARN_CACHE_FOLDER}
    # Install dependencies with frozen-lockfile to prevent unexpected changes
    - yarn install --frozen-lockfile --prefer-offline
    # Create .env.test file for tests using GitLab CI/CD variables
    - |
      cat > .env.test << EOF
      API_BASE_URL=${API_BASE_URL}
      API_VERSION=${API_VERSION}
      USERNAME=${TEST_USERNAME}
      PASSWORD=${TEST_PASSWORD}
      EOF
    # Debug: Print the contents of .env.test (excluding sensitive data)
    - echo "=== .env.test Contents ==="
    - cat .env.test | sed 's/PASSWORD=.*/PASSWORD=[MASKED]/'
    - echo "=== End .env.test Contents ==="
  script:
    - echo "Running unit tests..."
    - yarn test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
    paths:
      - coverage/
      - .env.test
      - junit.xml
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "test/unit-test-workflow"'
      changes:
        - "**/*"
    - when: manual
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - script_failure
  after_script:
    # Temporarily commented out for debugging
    # - rm -f .env.test

# Notification job
notify_test_results:
  stage: notify
  tags:
    - rmsdktest
  needs:
    - unit_tests
  before_script:
    - yarn add nodemailer xml2js
  script:
    - |
      node -e "
      const nodemailer = require('nodemailer');
      const fs = require('fs');
      const xml2js = require('xml2js');
      
      // Parse junit.xml and calculate statistics
      const xml = fs.readFileSync('junit.xml', 'utf8');
      let parser = new xml2js.Parser();
      let testSuites = [];
      let totalTests = 0;
      let passedTests = 0;
      let failedTests = 0;
      let skippedTests = 0;
      
      parser.parseString(xml, (err, result) => {
        if (err) {
          console.error('Error parsing XML:', err);
          process.exit(1);
        }
        
        const suites = result.testsuites.testsuite || [];
        suites.forEach(suite => {
          const total = parseInt(suite.$.tests) || 0;
          const failed = parseInt(suite.$.failures) || 0;
          const skipped = parseInt(suite.$.skipped) || 0;
          const passed = total - failed - skipped;
          
          const testCases = (suite.testcase || []).map(testCase => ({
            name: testCase.$.name,
            time: parseFloat(testCase.$.time).toFixed(3)
          }));
          
          testSuites.push({
            name: suite.$.name,
            total: total,
            passed: passed,
            failed: failed,
            skipped: skipped,
            duration: parseFloat(suite.$.time).toFixed(3),
            testCases: testCases
          });
          
          totalTests += total;
          passedTests += passed;
          failedTests += failed;
          skippedTests += skipped;
        });
      });
      
      // Debug logs
      console.log('=== Email Configuration Debug ===');
      console.log('SMTP Host:', '$SMTP_HOST');
      console.log('SMTP Port:', '$SMTP_PORT');
      console.log('SMTP Secure:', $SMTP_SECURE === 'true');
      console.log('Email User:', '$EMAIL_USER');
      console.log('To Emails:', '$TO_EMAILS');
      console.log('=== End Configuration Debug ===');
      
      const transporter = nodemailer.createTransport({
        host: '$SMTP_HOST',
        port: '$SMTP_PORT',
        secure: $SMTP_SECURE === 'true',
        auth: {
          user: '$EMAIL_USER',
          pass: '$EMAIL_PASSWORD'
        }
      });
      
      // Test SMTP connection
      console.log('Testing SMTP connection...');
      transporter.verify(function(error, success) {
        if (error) {
          console.error('SMTP Connection Error:', error);
          process.exit(1);
        } else {
          console.log('SMTP Connection Successful!');
        }
      });
      
      const mailOptions = {
        from: '$EMAIL_USER',
        to: '$TO_EMAILS',
        subject: '[Rainmaker-Base-SDK] Test Report - ' + new Date().toISOString().split('T')[0],
        html: \`
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .dashboard { background: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
              .stats { display: flex; justify-content: space-around; margin: 20px 0; }
              .stat-box { background: white; padding: 15px; border-radius: 5px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .success { color: #28a745; }
              .failure { color: #dc3545; }
              .skipped { color: #ffc107; }
              .test-suite { margin-top: 20px; }
              .test-suite h3 { color: #333; margin-bottom: 10px; }
              .test-case { margin-left: 20px; }
              .test-case-name { font-weight: bold; }
              .test-case-time { color: #666; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <div class="dashboard">
              <h2>Test Report Summary</h2>
              <div class="stats">
                <div class="stat-box">
                  <h3>Total Tests</h3>
                  <p>\${totalTests}</p>
                </div>
                <div class="stat-box success">
                  <h3>Passed</h3>
                  <p>\${passedTests}</p>
                </div>
                <div class="stat-box failure">
                  <h3>Failed</h3>
                  <p>\${failedTests}</p>
                </div>
                <div class="stat-box skipped">
                  <h3>Skipped</h3>
                  <p>\${skippedTests}</p>
                </div>
              </div>
              
              \${testSuites.map(suite => \`
                <div class="test-suite">
                  <h3>\${suite.name}</h3>
                  <div class="test-suite-stats">
                    <p>Total Tests: \${suite.total} | Passed: \${suite.passed} | Failed: \${suite.failed} | Skipped: \${suite.skipped} | Duration: \${suite.duration}s</p>
                  </div>
                  <div class="test-cases">
                    \${suite.testCases.map(testCase => \`
                      <div class="test-case">
                        <span class="test-case-name">\${testCase.name}</span>
                        <span class="test-case-time">(\${testCase.time}s)</span>
                      </div>
                    \`).join('')}
                  </div>
                </div>
              \`).join('')}
            </div>
            <p>Detailed test report is attached as junit.xml</p>
          </body>
          </html>
        \`,
        attachments: [
          {
            filename: 'junit.xml',
            path: 'junit.xml'
          }
        ]
      };
      
      transporter.sendMail(mailOptions, (error, info) => {
        if (error) {
          console.error('Error sending email:', error);
          process.exit(1);
        } else {
          console.log('Email sent:', info.response);
          process.exit(0);
        }
      });"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "test/unit-test-workflow"'
      when: on_success
    - when: manual
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Merge to master job
merge_to_master:
  stage: merge
  tags:
    - rmsdktest
  needs:
    - unit_tests
  script:
    - echo "All tests passed, ready for merge to master"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  allow_failure: false
